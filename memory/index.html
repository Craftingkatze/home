<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>8x8 Memory mit Logger</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            gap: 20px;
        }
        
        .game-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }
        
        .stats {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            width: 100%;
            max-width: 600px;
        }
        
        .stats h2 {
            color: #667eea;
            margin-bottom: 15px;
        }
        
        .stat-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }
        
        .stat-label {
            font-weight: bold;
            color: #555;
        }
        
        .stat-value {
            color: #667eea;
            font-weight: bold;
        }
        
        .memory-board {
            display: grid;
            grid-template-columns: repeat(8, 70px);
            grid-template-rows: repeat(8, 70px);
            gap: 10px;
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        
        .card {
            width: 70px;
            height: 70px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            color: white;
            transition: all 0.3s ease;
            position: relative;
            transform-style: preserve-3d;
        }
        
        .card.flipped {
            background: white;
            border: 3px solid #667eea;
            transform: rotateY(180deg);
        }
        
        .card.matched {
            background: #48bb78;
            border: 3px solid #38a169;
            cursor: default;
            opacity: 0.6;
        }
        
        .card:hover:not(.flipped):not(.matched) {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        
        .card-content {
            display: none;
        }
        
        .card.flipped .card-content,
        .card.matched .card-content {
            display: block;
            transform: rotateY(180deg);
        }
        
        .logger {
            width: 400px;
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            max-height: 90vh;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }
        
        .logger h3 {
            color: #667eea;
            margin-bottom: 15px;
            position: sticky;
            top: 0;
            background: white;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }
        
        .log-entry {
            padding: 10px;
            margin: 5px 0;
            border-radius: 8px;
            font-size: 14px;
            background: #f7fafc;
            border-left: 4px solid #667eea;
        }
        
        .log-entry.success {
            background: #c6f6d5;
            border-left-color: #48bb78;
        }
        
        .log-entry.fail {
            background: #fed7d7;
            border-left-color: #f56565;
        }
        
        .log-time {
            font-size: 12px;
            color: #999;
            margin-bottom: 5px;
        }
        
        .probability {
            font-size: 12px;
            color: #667eea;
            font-weight: bold;
            margin-top: 5px;
        }
        
        .reset-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 10px;
        }
        
        .reset-btn:hover {
            background: #764ba2;
            transform: scale(1.05);
        }
        
        .export-btn {
            background: #48bb78;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            margin-top: 10px;
        }
        
        .export-btn:hover {
            background: #38a169;
        }
        
        .player-input-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .player-input-box {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
            text-align: center;
            max-width: 500px;
        }
        
        .player-input-box h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 28px;
        }
        
        .player-input-box p {
            color: #666;
            margin-bottom: 20px;
            line-height: 1.6;
        }
        
        .player-input-box input {
            width: 100%;
            padding: 15px;
            border: 2px solid #667eea;
            border-radius: 10px;
            font-size: 18px;
            margin-bottom: 20px;
            box-sizing: border-box;
        }
        
        .player-input-box input:focus {
            outline: none;
            border-color: #764ba2;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
        }
        
        .player-input-box button {
            background: #667eea;
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 10px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .player-input-box button:hover:not(:disabled) {
            background: #764ba2;
            transform: scale(1.05);
        }
        
        .player-input-box button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .player-name-display {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 10px 20px;
            border-radius: 10px;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .warning-text {
            color: #f56565;
            font-size: 14px;
            font-weight: bold;
            margin-top: 10px;
        }
        
        .save-status {
            margin-top: 10px;
            padding: 10px;
            border-radius: 8px;
            font-size: 14px;
            display: none;
        }
        
        .save-success {
            background: #c6f6d5;
            color: #22543d;
            border: 1px solid #9ae6b4;
        }
        
        .save-error {
            background: #fed7d7;
            color: #742a2a;
            border: 1px solid #feb2b2;
        }
    </style>
</head>
<body>
    <!-- Player Name Input Modal -->
    <div class="player-input-modal" id="playerModal">
        <div class="player-input-box">
            <h2>üéÆ Willkommen zum Memory Spiel!</h2>
            <p>Bitte gib deinen Spielernamen ein.<br>
            <strong>‚ö†Ô∏è Wichtig:</strong> Verwende immer den <strong>gleichen Namen</strong> f√ºr deine Spiele!</p>
            <p class="warning-text">Das System erkennt, wenn du unter verschiedenen Namen spielst!</p>
            <input type="text" id="playerNameInput" placeholder="Dein Name..." maxlength="30">
            <button onclick="startGame()">Spiel starten</button>
        </div>
    </div>
    
    <div class="game-container">
        <div class="player-name-display" id="playerDisplay" style="display: none;">
            Spieler: <span id="currentPlayer"></span>
        </div>
        
        <div class="stats">
            <h2>üìä Statistiken</h2>
            <div class="stat-row">
                <span class="stat-label">Runde:</span>
                <span class="stat-value" id="round">0</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Gefundene Paare:</span>
                <span class="stat-value" id="pairs">0 / 32</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Erfolgreiche Runden:</span>
                <span class="stat-value" id="successful">0</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Erfolglose Runden:</span>
                <span class="stat-value" id="unsuccessful">0</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Erfolgsrate:</span>
                <span class="stat-value" id="successRate">0%</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Verbleibende Karten:</span>
                <span class="stat-value" id="remaining">64</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Aktuelle P(Paar):</span>
                <span class="stat-value" id="currentProb">1.59%</span>
            </div>
        </div>
        
        <div class="memory-board" id="board"></div>
        
        <button class="reset-btn" onclick="resetGame()">üîÑ Neues Spiel</button>
    </div>
    
    <div class="logger">
        <h3>üìù Spielverlauf Log</h3>
        <div id="saveStatus" class="save-status" style="display: none;"></div>
        <button class="export-btn" onclick="saveToServer()">üíæ Auf Server speichern</button>
        <div id="log"></div>
    </div>

    <script>
        const emojis = ['üéÆ', 'üéØ', 'üé®', 'üé≠', 'üé™', 'üé∏', 'üéπ', 'üé∫', 'üéª', 'üé≤', 'üé∞', 'üé≥', 'üèÄ', '‚öΩ', 'üèà', '‚öæ', 'üéæ', 'üèê', 'üèâ', 'üé±', 'üèì', 'üè∏', 'üèí', 'üèë', 'ü•ä', 'ü•ã', 'üéø', 'üõπ', 'üéØ', 'üéÆ', 'üé™', 'üé®'];
        
        let cards = [];
        let flippedCards = [];
        let matchedPairs = 0;
        let roundCount = 0;
        let successfulRounds = 0;
        let unsuccessfulRounds = 0;
        let isProcessing = false;
        let gameLog = [];
        let playerName = '';
        let gameStartTime = null;
        let sessionId = null;
        
        // Generate unique session ID
        function generateSessionId() {
            return 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }
        
        // Get browser fingerprint (einfache Version)
        function getBrowserFingerprint() {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            ctx.textBaseline = 'top';
            ctx.font = '14px Arial';
            ctx.fillText('fingerprint', 2, 2);
            const dataURL = canvas.toDataURL();
            
            const fingerprint = {
                userAgent: navigator.userAgent,
                language: navigator.language,
                platform: navigator.platform,
                screenResolution: `${screen.width}x${screen.height}`,
                timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                canvasFingerprint: dataURL.substring(0, 100)
            };
            
            // Simple hash
            const str = JSON.stringify(fingerprint);
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            return 'fp_' + Math.abs(hash).toString(36);
        }
        
        function startGame() {
            const input = document.getElementById('playerNameInput');
            const name = input.value.trim();
            
            if (name === '') {
                alert('Bitte gib einen Namen ein!');
                return;
            }
            
            playerName = name;
            sessionId = generateSessionId();
            gameStartTime = new Date();
            
            document.getElementById('playerModal').style.display = 'none';
            document.getElementById('playerDisplay').style.display = 'block';
            document.getElementById('currentPlayer').textContent = playerName;
            
            initGame();
        }
        
        function initGame() {
            const board = document.getElementById('board');
            board.innerHTML = '';
            cards = [];
            flippedCards = [];
            matchedPairs = 0;
            roundCount = 0;
            successfulRounds = 0;
            unsuccessfulRounds = 0;
            gameLog = [];
            
            if (!gameStartTime) {
                gameStartTime = new Date();
            }
            
            // Erstelle 32 Paare
            const cardPairs = [];
            for (let i = 0; i < 32; i++) {
                cardPairs.push(emojis[i], emojis[i]);
            }
            
            // Mische die Karten
            cardPairs.sort(() => Math.random() - 0.5);
            
            // Erstelle das Board
            cardPairs.forEach((emoji, index) => {
                const card = document.createElement('div');
                card.className = 'card';
                card.dataset.emoji = emoji;
                card.dataset.index = index;
                card.innerHTML = `<span class="card-content">${emoji}</span>`;
                card.addEventListener('click', () => flipCard(card));
                board.appendChild(card);
                cards.push(card);
            });
            
            updateStats();
            document.getElementById('log').innerHTML = '';
            addLog(`Spiel gestartet von ${playerName}! 64 Karten, 32 Paare`, 'info');
        }
        
        function flipCard(card) {
            if (isProcessing || card.classList.contains('flipped') || card.classList.contains('matched')) {
                return;
            }
            
            card.classList.add('flipped');
            flippedCards.push(card);
            
            if (flippedCards.length === 2) {
                isProcessing = true;
                roundCount++;
                checkMatch();
            }
        }
        
        function checkMatch() {
            const [card1, card2] = flippedCards;
            const emoji1 = card1.dataset.emoji;
            const emoji2 = card2.dataset.emoji;
            
            const remainingCards = 64 - (matchedPairs * 2);
            const theoreticalProb = (1 / (remainingCards - 1) * 100).toFixed(2);
            
            if (emoji1 === emoji2) {
                // Match gefunden!
                setTimeout(() => {
                    card1.classList.add('matched');
                    card2.classList.add('matched');
                    matchedPairs++;
                    successfulRounds++;
                    
                    const logEntry = {
                        round: roundCount,
                        result: 'Erfolg',
                        card1: emoji1,
                        card2: emoji2,
                        pairsFound: matchedPairs,
                        cardsRemaining: 64 - (matchedPairs * 2),
                        theoreticalProb: theoreticalProb,
                        timestamp: new Date().toLocaleTimeString()
                    };
                    gameLog.push(logEntry);
                    
                    addLog(
                        `Runde ${roundCount}: Paar gefunden! ${emoji1} = ${emoji2}<br>
                        Paare: ${matchedPairs}/32 | Verbleibend: ${64 - (matchedPairs * 2)} Karten`,
                        'success',
                        theoreticalProb
                    );
                    
                    flippedCards = [];
                    isProcessing = false;
                    updateStats();
                    
                    if (matchedPairs === 32) {
                        setTimeout(() => {
                            addLog(`üéâ SPIEL GEWONNEN! Alle 32 Paare gefunden in ${roundCount} Runden!`, 'success');
                            addLog(`Erfolgsrate: ${(successfulRounds/roundCount*100).toFixed(2)}%`, 'info');
                            // Automatisch speichern, wenn Spiel beendet
                            setTimeout(() => {
                                saveToServer();
                            }, 1000);
                        }, 500);
                    }
                }, 500);
            } else {
                // Kein Match
                setTimeout(() => {
                    card1.classList.remove('flipped');
                    card2.classList.remove('flipped');
                    unsuccessfulRounds++;
                    
                    const logEntry = {
                        round: roundCount,
                        result: 'Fehlschlag',
                        card1: emoji1,
                        card2: emoji2,
                        pairsFound: matchedPairs,
                        cardsRemaining: 64 - (matchedPairs * 2),
                        theoreticalProb: theoreticalProb,
                        timestamp: new Date().toLocaleTimeString()
                    };
                    gameLog.push(logEntry);
                    
                    addLog(
                        `Runde ${roundCount}: Kein Paar. ${emoji1} ‚â† ${emoji2}<br>
                        Paare: ${matchedPairs}/32 | Verbleibend: ${64 - (matchedPairs * 2)} Karten`,
                        'fail',
                        theoreticalProb
                    );
                    
                    flippedCards = [];
                    isProcessing = false;
                    updateStats();
                }, 1000);
            }
        }
        
        function updateStats() {
            document.getElementById('round').textContent = roundCount;
            document.getElementById('pairs').textContent = `${matchedPairs} / 32`;
            document.getElementById('successful').textContent = successfulRounds;
            document.getElementById('unsuccessful').textContent = unsuccessfulRounds;
            
            const successRate = roundCount > 0 ? (successfulRounds / roundCount * 100).toFixed(2) : 0;
            document.getElementById('successRate').textContent = `${successRate}%`;
            
            const remainingCards = 64 - (matchedPairs * 2);
            document.getElementById('remaining').textContent = remainingCards;
            
            const currentProb = remainingCards > 1 ? (1 / (remainingCards - 1) * 100).toFixed(2) : 100;
            document.getElementById('currentProb').textContent = `${currentProb}%`;
        }
        
        function addLog(message, type = 'info', probability = null) {
            const logDiv = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            
            let content = `<div class="log-time">${new Date().toLocaleTimeString()}</div>${message}`;
            if (probability) {
                content += `<div class="probability">Theoretische P(Paar): ${probability}%</div>`;
            }
            
            entry.innerHTML = content;
            logDiv.insertBefore(entry, logDiv.firstChild);
        }
        
        function resetGame() {
            if (matchedPairs === 32) {
                // Spiel ist fertig, neues Spiel mit gleichem Spieler
                gameStartTime = new Date();
                sessionId = generateSessionId();
                initGame();
            } else if (confirm('M√∂chtest du wirklich ein neues Spiel starten? Das aktuelle Spiel wird nicht gespeichert!')) {
                gameStartTime = new Date();
                sessionId = generateSessionId();
                initGame();
            }
        }
        
        function saveToServer() {
            if (gameLog.length === 0) {
                alert('Keine Daten zum Speichern vorhanden!');
                return;
            }
            
            const gameEndTime = new Date();
            const gameDuration = Math.floor((gameEndTime - gameStartTime) / 1000);
            const browserFingerprint = getBrowserFingerprint();
            const successRate = roundCount > 0 ? (successfulRounds / roundCount * 100).toFixed(2) : 0;
            
            // Spielzusammenfassung erstellen
            const gameSummary = {
                playerName: playerName,
                sessionId: sessionId,
                browserFingerprint: browserFingerprint,
                date: gameStartTime.toLocaleDateString('de-DE'),
                startTime: gameStartTime.toLocaleTimeString('de-DE'),
                endTime: gameEndTime.toLocaleTimeString('de-DE'),
                gameDuration: gameDuration,
                totalRounds: roundCount,
                successfulRounds: successfulRounds,
                unsuccessfulRounds: unsuccessfulRounds,
                successRate: successRate,
                matchedPairs: matchedPairs,
                gameCompleted: matchedPairs === 32
            };
            
            // Daten f√ºr den Server vorbereiten
            const gameData = {
                summary: gameSummary,
                rounds: gameLog
            };
            
            // Status anzeigen
            const statusDiv = document.getElementById('saveStatus');
            statusDiv.style.display = 'block';
            statusDiv.className = 'save-status';
            statusDiv.textContent = 'Daten werden gespeichert...';
            
            // AJAX Request an PHP-Skript
            fetch('save_game.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(gameData)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    statusDiv.className = 'save-status save-success';
                    statusDiv.textContent = '‚úÖ Daten erfolgreich auf Server gespeichert!';
                    addLog('‚úÖ Spiel wurde auf Server gespeichert!', 'success');
                } else {
                    throw new Error(data.message || 'Unbekannter Fehler');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                statusDiv.className = 'save-status save-error';
                statusDiv.textContent = '‚ùå Fehler beim Speichern: ' + error.message;
                addLog('‚ùå Fehler beim Speichern auf Server!', 'fail');
                
                // Fallback: Lokalen Download anbieten
                if (confirm('Server-Speicherung fehlgeschlagen. M√∂chten Sie die Daten stattdessen lokal herunterladen?')) {
                    saveGameToFile();
                }
            });
            
            // Status nach 5 Sekunden ausblenden
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 5000);
        }
        
        // Fallback-Funktion f√ºr lokalen Download
        function saveGameToFile() {
            const gameEndTime = new Date();
            const gameDuration = Math.floor((gameEndTime - gameStartTime) / 1000);
            const browserFingerprint = getBrowserFingerprint();
            
            let csv = '';
            
            // Header f√ºr die Zusammenfassung
            csv += '=== SPIEL ZUSAMMENFASSUNG ===\n';
            csv += 'Spieler,Session-ID,Browser-Fingerprint,Datum,Startzeit,Endzeit,Spieldauer(Sek),Gesamtrunden,Erfolgreiche,Erfolglose,Erfolgsrate(%)\n';
            
            const successRate = (successfulRounds / roundCount * 100).toFixed(2);
            csv += `${playerName},${sessionId},${browserFingerprint},${gameStartTime.toLocaleDateString('de-DE')},${gameStartTime.toLocaleTimeString('de-DE')},${gameEndTime.toLocaleTimeString('de-DE')},${gameDuration},${roundCount},${successfulRounds},${unsuccessfulRounds},${successRate}\n\n`;
            
            // Detaillierte Runden
            csv += '=== DETAILLIERTE RUNDEN ===\n';
            csv += 'Runde,Ergebnis,Karte1,Karte2,Gefundene_Paare,Verbleibende_Karten,Theoretische_P(Paar)%,Zeitstempel\n';
            
            gameLog.forEach(entry => {
                csv += `${entry.round},${entry.result},${entry.card1},${entry.card2},${entry.pairsFound},${entry.cardsRemaining},${entry.theoreticalProb},${entry.timestamp}\n`;
            });
            
            // Download erstellen
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `memory_game_${playerName}_${Date.now()}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            addLog('‚úÖ Spiel wurde lokal gespeichert!', 'success');
        }
        
        // Beim Laden der Seite Modal anzeigen
        window.onload = function() {
            document.getElementById('playerModal').style.display = 'flex';
        }
        
        // Enter-Taste im Input
        document.addEventListener('DOMContentLoaded', function() {
            const input = document.getElementById('playerNameInput');
            if (input) {
                input.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        startGame();
                    }
                });
            }
        });
    </script>
</body>
</html>