<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BVG Berlin - Live</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="trainRoutes.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        * { box-sizing: border-box; }
        body { font-family: Arial, sans-serif; text-align: center; margin: 0; padding: 0; }

        /* â”€â”€ Mode Toggle â”€â”€ */
        #mode-toggle-bar {
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 12px auto 0;
        }
        .mode-btn {
            padding: 8px 22px;
            font-size: 14px;
            font-weight: bold;
            border: 2px solid #2c3e50;
            background: white;
            color: #2c3e50;
            cursor: pointer;
            transition: all 0.2s;
        }
        .mode-btn:first-child { border-radius: 6px 0 0 6px; border-right: none; }
        .mode-btn:last-child  { border-radius: 0 6px 6px 0; }
        .mode-btn.active { background: #2c3e50; color: white; }

        /* â”€â”€ Controls â”€â”€ */
        .controls { margin: 10px 0; }
        .control-button {
            padding: 8px 15px;
            background-color: #2c3e50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 0 5px;
        }
        .control-button.active-live { background-color: #c0392b; }
        .refresh-info { margin: 6px 0; font-size: 14px; color: #666; }

        /* â”€â”€ Schematic SVG â”€â”€ */
        #view-schematic { display: block; }
        #svg-container {
            overflow: hidden;
            width: 100%;
            background: white;
            position: relative;
        }
        #svg-container svg { border: 1px solid #ccc; width: 100%; height: 100vh; display: block; }

        #zoom-controls {
            position: fixed;
            bottom: 20px; right: 20px;
            display: flex; flex-direction: column; gap: 6px;
            z-index: 999;
        }
        #svg-container:fullscreen #zoom-controls,
        #svg-container:-webkit-full-screen #zoom-controls { position: absolute; }
        .zoom-btn {
            width: 38px; height: 38px; font-size: 22px;
            background: #2c3e50; color: white; border: none;
            border-radius: 6px; cursor: pointer;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            display: flex; align-items: center; justify-content: center;
        }
        .zoom-btn:hover { background: #3d5166; }
        #svg-container:fullscreen  { background-color: white; }
        #svg-container:-webkit-full-screen { background-color: white; }
        #svg-container:-moz-full-screen    { background-color: white; }
        ::backdrop { background-color: white; }

        .stationinfo {
            position: fixed;
            background-color: rgba(30,30,30,0.92);
            color: white;
            padding: 6px 12px;
            border-radius: 6px;
            pointer-events: none;
            font-size: 14px;
            z-index: 2000;
            max-width: 260px;
        }
        .U1{color:#7dad4c}.U2{color:#da421e}.U3{color:#16683d}.U4{color:#f0d722}
        .U5{color:#7e5330}.U6{color:#8c6dab}.U7{color:#009bd5}.U8{color:#224f86}
        .U9{color:#f3791d}.U12{color:#000768}

        /* â”€â”€ Leaflet â”€â”€ */
        #view-leaflet { display: none; }
        #map { height: calc(100vh - 165px); width: 100%; }
    </style>
</head>
<body>

<h1 style="margin:10px 0 0;">BVG Berlin â€“ Live U-Bahn Tracker</h1>

<div id="mode-toggle-bar">
    <button class="mode-btn active" id="btn-schematic" onclick="switchMode('schematic')">ðŸ—º Schematisch</button>
    <button class="mode-btn"        id="btn-leaflet"   onclick="switchMode('leaflet')">ðŸ›° Echte Karte</button>
</div>

<div class="controls">
    <button id="toggle-live"     class="control-button active-live">Live-Daten deaktivieren</button>
    <button id="refresh-data"    class="control-button">Daten aktualisieren</button>
    <button id="fullscreen-toggle" class="control-button">Vollbild</button>
</div>
<div class="refresh-info">
    Letzte Aktualisierung: <span id="last-update">-</span> | Aktive ZÃ¼ge: <span id="train-count">0</span>
</div>
<div id="line-toggle-container" class="controls">
    <label><input type="checkbox" class="line-toggle" value="U1"  checked> U1</label>
    <label><input type="checkbox" class="line-toggle" value="U2"  checked> U2</label>
    <label><input type="checkbox" class="line-toggle" value="U3"  checked> U3</label>
    <label><input type="checkbox" class="line-toggle" value="U4"  checked> U4</label>
    <label><input type="checkbox" class="line-toggle" value="U5"  checked> U5</label>
    <label><input type="checkbox" class="line-toggle" value="U6"  checked> U6</label>
    <label><input type="checkbox" class="line-toggle" value="U7"  checked> U7</label>
    <label><input type="checkbox" class="line-toggle" value="U8"  checked> U8</label>
    <label><input type="checkbox" class="line-toggle" value="U9"  checked> U9</label>
</div>

<!-- SCHEMATIC -->
<div id="view-schematic">
    <div id="svg-container">
        <div id="zoom-controls">
            <button class="zoom-btn" id="zoom-in"    title="Hineinzoomen">+</button>
            <button class="zoom-btn" id="zoom-reset" title="ZurÃ¼cksetzen" style="font-size:13px;">âŒ‚</button>
            <button class="zoom-btn" id="zoom-out"   title="Herauszoomen">âˆ’</button>
        </div>
    </div>
</div>
<div id="stationinfo" class="stationinfo" style="display:none;"></div>

<!-- LEAFLET -->
<div id="view-leaflet">
    <div id="map"></div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let currentMode = 'schematic';
let liveMode    = true;
let liveInterval;
let liveTrains  = {};
let existingTrainIds = new Set();

const lineColors = {
    'U1':'#7dad4c','U2':'#da421e','U3':'#16683d','U4':'#f0d722',
    'U5':'#7e5330','U6':'#8c6dab','U7':'#009bd5','U8':'#224f86',
    'U9':'#f3791d','U12':'#000768'
};
let visibleLines = {U1:true,U2:true,U3:true,U4:true,U5:true,U6:true,U7:true,U8:true,U9:true,U12:true};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MODE SWITCH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function switchMode(mode) {
    currentMode = mode;
    document.getElementById('view-schematic').style.display = mode === 'schematic' ? 'block' : 'none';
    document.getElementById('view-leaflet').style.display   = mode === 'leaflet'   ? 'block' : 'none';
    document.getElementById('btn-schematic').classList.toggle('active', mode === 'schematic');
    document.getElementById('btn-leaflet').classList.toggle('active',   mode === 'leaflet');
    if (mode === 'leaflet' && !leafletMap) initLeaflet();
    if (mode === 'leaflet' && leafletMap)  setTimeout(() => leafletMap.invalidateSize(), 100);
    if (mode === 'schematic' && fitToScreen) fitToScreen();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LINE TOGGLES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.querySelectorAll('.line-toggle').forEach(cb => {
    cb.addEventListener('change', function() {
        const line = this.value;
        visibleLines[line] = this.checked;
        document.querySelectorAll(`.live-train.${line}`).forEach(el => {
            el.style.display = this.checked ? '' : 'none';
        });
        Object.entries(leafletMarkers).forEach(([id, m]) => {
            if (id.startsWith(line + '_')) {
                if (this.checked) { if (leafletMap) m.addTo(leafletMap); }
                else              { if (leafletMap) leafletMap.removeLayer(m); }
            }
        });
    });
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ROUTE HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const allLines = {};
function initAllLines() {
    ['U1','U2','U3','U4','U5','U6','U7','U8','U9','U12'].forEach(l => {
        allLines[l] = window[`u${l.slice(1)}Points`] || [];
    });
}

function findNearestPoint(lat, lon, line) {
    const pts = allLines[line]; if (!pts || !pts.length) return null;
    let best = null, min = Infinity;
    pts.forEach(p => { const d = Math.hypot(p.xr-lat, p.yr-lon); if (d < min) { min=d; best=p; } });
    return best;
}
function findNextStation(cp, line, dir) {
    const pts = allLines[line]; if (!pts || !pts.length) return "Unbekannt";
    let ci = -1;
    for (let i=0;i<pts.length;i++) if (Math.abs(pts[i].x-cp.x)<5 && Math.abs(pts[i].y-cp.y)<5) { ci=i; break; }
    if (ci===-1) return "Unbekannt";
    const range = dir===1 ? pts.slice(ci+1) : pts.slice(0,ci).reverse();
    const found = range.find(p => p.station && !p.station.toLowerCase().includes("zwischen"));
    return found ? found.station : "ENDE";
}
function determineDirection(prev, cur, line) {
    if (!prev) return 1;
    const pts = allLines[line]; if (!pts || pts.length<2) return 1;
    let pi=-1, ci=-1;
    for (let i=0;i<pts.length;i++) {
        if (Math.abs(pts[i].x-prev.x)<5 && Math.abs(pts[i].y-prev.y)<5) pi=i;
        if (Math.abs(pts[i].x-cur.x)<5  && Math.abs(pts[i].y-cur.y)<5)  ci=i;
    }
    if (pi===-1 || ci===-1) return 1;
    return ci>pi ? 1 : -1;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FETCH LIVE DATA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function fetchLiveData() {
    try {
        checkAndCleanDuplicates();
        const res  = await fetch('https://v6.vbb.transport.rest/radar?north=52.5994968&west=13.1926072&south=52.4122984&east=13.6351573&results=1000');
        const data = await res.json();
        if (!data || !data.movements) return;

        const toRemove = new Set(Object.keys(liveTrains));
        const now = new Date();

        data.movements.forEach(v => {
            if (!v.line || v.line.productName !== 'U' || !v.location || !v.line.name || !v.tripId) return;
            const line = v.line.name;
            const uid  = `${line}_${v.tripId}`;
            toRemove.delete(uid);
            const np = findNearestPoint(v.location.latitude, v.location.longitude, line);
            if (!np) return;

            if (existingTrainIds.has(uid) && liveTrains[uid]) {
                const prev = liveTrains[uid];
                const dir  = determineDirection(prev, np, line);
                const ns   = findNextStation(np, line, dir);
                if (prev.element && (prev.x!==np.x || prev.y!==np.y)) prev.element.attr("x",np.x).attr("y",np.y);
                updateLeafletMarker(uid, line, v, np, ns);
                liveTrains[uid] = {...prev, x:np.x, y:np.y, lastUpdated:now, nextStation:ns, direction:v.direction||"Unbekannt"};
            } else {
                existingTrainIds.add(uid);
                const ns = findNextStation(np, line, 1);
                liveTrains[uid] = {line, x:np.x, y:np.y, lastUpdated:now, nextStation:ns, direction:v.direction||"Unbekannt"};
                spawnSchematicTrain(uid, line, np);
                spawnLeafletMarker(uid, line, v, np, ns);
            }
        });

        toRemove.forEach(id => removeTrain(id));
        Object.keys(liveTrains).forEach(id => { if (now-liveTrains[id].lastUpdated>120000) removeTrain(id); });
        document.getElementById('last-update').textContent = now.toLocaleTimeString('de-DE');
        updateTrainCount();
    } catch(e) { console.error("Fetch-Fehler:", e); }
}

function removeTrain(id) {
    const t = liveTrains[id];
    if (t) {
        if (t.element) t.element.remove();
        if (leafletMarkers[id] && leafletMap) leafletMap.removeLayer(leafletMarkers[id]);
        delete leafletMarkers[id];
    }
    delete liveTrains[id];
    existingTrainIds.delete(id);
}
function checkAndCleanDuplicates() {
    existingTrainIds.clear();
    const m = new Map();
    document.querySelectorAll('[data-train-id]').forEach(el => {
        const id = el.getAttribute('data-train-id');
        if (!m.has(id)) m.set(id,[]);
        m.get(id).push(el);
        existingTrainIds.add(id);
    });
    m.forEach(arr => { for (let i=1;i<arr.length;i++) arr[i].remove(); });
    Object.keys(liveTrains).forEach(id => {
        if (!document.querySelector(`[data-train-id="${id}"]`)) delete liveTrains[id];
    });
}
function updateTrainCount() {
    document.getElementById('train-count').textContent = existingTrainIds.size;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SCHEMATIC
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let svg, fitToScreen;
const stationinfoEl = document.getElementById('stationinfo');

d3.xml("bvggrafik1a.svg").then(function(xml) {
    const container    = document.getElementById("svg-container");
    const zoomControls = document.getElementById("zoom-controls");
    container.insertBefore(xml.documentElement, zoomControls);
    svg = d3.select("svg");

    const svgNode    = svg.node();
    const vb         = svgNode.viewBox.baseVal;
    const svgNW      = vb.width  || 1000;
    const svgNH      = vb.height || 800;

    const zg = document.createElementNS("http://www.w3.org/2000/svg","g");
    zg.setAttribute("class","zoom-layer");
    while (svgNode.firstChild) zg.appendChild(svgNode.firstChild);
    svgNode.appendChild(zg);
    const zoomSel = d3.select(zg);

    svg.style("width","100%").style("height","100vh").style("display","block");

    const zb = d3.zoom().scaleExtent([0.3,10]).on("zoom", e => zoomSel.attr("transform", e.transform));
    svg.call(zb);
    container.addEventListener("wheel", e => e.preventDefault(), {passive:false});

    fitToScreen = () => {
        const cw = container.clientWidth  || window.innerWidth;
        const ch = container.clientHeight || window.innerHeight;
        const sc = Math.min(cw/svgNW, ch/svgNH) * 0.97;
        svg.call(zb.transform, d3.zoomIdentity.translate((cw-svgNW*sc)/2,(ch-svgNH*sc)/2).scale(sc));
    };

    document.getElementById("zoom-in").onclick    = () => svg.transition().duration(250).call(zb.scaleBy,1.5);
    document.getElementById("zoom-out").onclick   = () => svg.transition().duration(250).call(zb.scaleBy,1/1.5);
    document.getElementById("zoom-reset").onclick = () => fitToScreen();
    document.addEventListener("fullscreenchange", () => setTimeout(fitToScreen,150));
    window.addEventListener("resize", fitToScreen);
    setTimeout(fitToScreen, 50);

    initAllLines();
    startLive(); // â† Auto-start live
}).catch(e => console.error("SVG-Ladefehler:", e));

function spawnSchematicTrain(uid, line, np) {
    if (!svg) return;
    const path = line==="U12" ? "u12punkt1.svg" : `${line.toLowerCase()}punkt1.svg`;
    d3.xml(path).then(function(tx) {
        const train = svg.node().appendChild(tx.documentElement);
        const bbox  = train.getBBox();
        const sc    = 0.5;
        train.setAttribute("width",  bbox.width*sc);
        train.setAttribute("height", bbox.height*sc);
        train.setAttribute("x", np.x);
        train.setAttribute("y", np.y);
        train.setAttribute("class", `live-train ${line}`);
        train.setAttribute("data-train-id", uid);
        if (!visibleLines[line]) train.style.display='none';

        train.addEventListener("mouseenter", () => {
            const td = liveTrains[uid];
            let html = `<strong>${line}</strong><br>Nach: ${td?.direction||'?'}`;
            html += td?.nextStation==="ENDE" ? `<br>Fahrt endet hier` : `<br>NÃ¤chste Station: ${td?.nextStation||'?'}`;
            stationinfoEl.innerHTML = html;
            stationinfoEl.style.display = 'block';
        });
        train.addEventListener("mousemove", e => {
            stationinfoEl.style.left = (e.pageX+12)+"px";
            stationinfoEl.style.top  = (e.pageY+12)+"px";
        });
        train.addEventListener("mouseleave", () => stationinfoEl.style.display='none');

        if (liveTrains[uid]) liveTrains[uid].element = d3.select(train);
        updateTrainCount();
    }).catch(e => console.error("Train-SVG-Fehler:", e));
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LEAFLET
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let leafletMap = null;
let leafletMarkers = {};

function initLeaflet() {
    leafletMap = L.map('map').setView([52.520, 13.405], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
    }).addTo(leafletMap);
    // Drop existing trains onto leaflet
    Object.entries(liveTrains).forEach(([id, t]) => {
        const pts = allLines[t.line];
        if (!pts) return;
        const np = pts.find(p => p.x===t.x && p.y===t.y) || pts[0];
        if (np) spawnLeafletMarker(id, t.line, null, np, t.nextStation);
    });
}

function makeLeafletIcon(line) {
    const c = lineColors[line]||'#333';
    return L.divIcon({
        className:'',
        html:`<div style="background:${c};width:26px;height:26px;border-radius:50%;border:3px solid white;box-shadow:0 1px 4px rgba(0,0,0,.4);display:flex;align-items:center;justify-content:center;font-size:9px;font-weight:bold;color:white;">${line.replace('U','')}</div>`,
        iconSize:[26,26], iconAnchor:[13,13]
    });
}
function spawnLeafletMarker(uid, line, vehicle, np, ns) {
    if (!leafletMap || !np || leafletMarkers[uid]) return;
    if (!np.xr || !np.yr) return;
    const dir = vehicle?.direction || liveTrains[uid]?.direction || '?';
    const m = L.marker([np.xr, np.yr], {icon: makeLeafletIcon(line)})
        .bindPopup(`<strong>${line}</strong><br>Nach: ${dir}<br>NÃ¤chste Station: ${ns||'?'}`)
        .addTo(leafletMap);
    if (!visibleLines[line]) leafletMap.removeLayer(m);
    leafletMarkers[uid] = m;
}
function updateLeafletMarker(uid, line, vehicle, np, ns) {
    if (!leafletMap) return;
    const m = leafletMarkers[uid];
    if (!m) { spawnLeafletMarker(uid, line, vehicle, np, ns); return; }
    if (np.xr && np.yr) m.setLatLng([np.xr, np.yr]);
    const dir = vehicle?.direction || liveTrains[uid]?.direction || '?';
    if (m.getPopup()) m.getPopup().setContent(`<strong>${line}</strong><br>Nach: ${dir}<br>NÃ¤chste Station: ${ns||'?'}`);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LIVE CONTROLS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function startLive() {
    liveMode = true;
    document.getElementById('toggle-live').textContent = 'Live-Daten deaktivieren';
    document.getElementById('toggle-live').classList.add('active-live');
    checkAndCleanDuplicates();
    fetchLiveData();
    liveInterval = setInterval(fetchLiveData, 3000);
}
function stopLive() {
    liveMode = false;
    document.getElementById('toggle-live').textContent = 'Live-Daten aktivieren';
    document.getElementById('toggle-live').classList.remove('active-live');
    clearInterval(liveInterval);
    Object.keys(liveTrains).forEach(id => removeTrain(id));
    liveTrains = {}; existingTrainIds.clear(); leafletMarkers = {};
    updateTrainCount();
}

document.getElementById('toggle-live').addEventListener('click', () => liveMode ? stopLive() : startLive());
document.getElementById('refresh-data').addEventListener('click', () => { if (liveMode) { checkAndCleanDuplicates(); fetchLiveData(); } });
document.getElementById('fullscreen-toggle').addEventListener('click', function() {
    const c = document.getElementById('svg-container');
    if (!document.fullscreenElement) c.requestFullscreen().catch(e => alert(`Vollbild-Fehler: ${e.message}`));
    else document.exitFullscreen();
});
</script>
</body>
</html>