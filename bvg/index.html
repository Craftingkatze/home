<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BVG Berlin - Live</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="trainRoutes.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        * { box-sizing: border-box; }
        body { font-family: Arial, sans-serif; text-align: center; margin: 0; padding: 0; background: #f4f7f6; }
        h1 { color: #2c3e50; margin: 12px 0 4px; font-size: 1.4em; }

        .controls { margin: 6px 0; display: flex; flex-wrap: wrap; justify-content: center; gap: 6px; padding: 0 10px; }

        .control-button {
            padding: 7px 14px; background: #2c3e50; color: white;
            border: none; border-radius: 5px; cursor: pointer; font-size: 14px;
        }
        .control-button:hover { background: #3d5166; }
        .control-button.active { background: #c0392b; }

        /* Kartenmodus-Umschalter */
        #map-mode-toggle { display: inline-flex; border-radius: 5px; overflow: hidden; border: 2px solid #2c3e50; }
        #map-mode-toggle button {
            padding: 7px 14px; border: none; cursor: pointer;
            font-size: 14px; background: white; color: #2c3e50; transition: background .2s, color .2s;
        }
        #map-mode-toggle button.active { background: #2c3e50; color: white; }

        .refresh-info { font-size: 13px; color: #666; margin: 3px 0 6px; }

        #line-toggle-container { margin: 2px 0 8px; display: flex; flex-wrap: wrap; justify-content: center; gap: 5px; padding: 0 10px; }
        #line-toggle-container label { font-size: 13px; cursor: pointer; }

        /* Schematische Karte */
        #svg-container { overflow: hidden; width: 100%; background: white; position: relative; }
        #svg-container svg { border: 1px solid #ccc; width: 100%; height: auto; display: block; }

        /* Leaflet */
        #leaflet-container { display: none; width: 100%; height: 85vh; position: relative; }
        #leaflet-map { width: 100%; height: 100%; }

        /* Vollbild */
        #svg-container:fullscreen,
        #svg-container:-webkit-full-screen,
        #svg-container:-moz-full-screen { background-color: white; }
        ::backdrop { background-color: white; }

        /* Zoom Buttons */
        #zoom-controls {
            position: fixed; bottom: 20px; right: 20px;
            display: flex; flex-direction: column; gap: 6px; z-index: 999;
        }
        #svg-container:fullscreen #zoom-controls { position: absolute; }
        .zoom-btn {
            width: 38px; height: 38px; font-size: 22px;
            background: #2c3e50; color: white; border: none;
            border-radius: 6px; cursor: pointer;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            display: flex; align-items: center; justify-content: center;
        }
        .zoom-btn:hover { background: #3d5166; }

        /* Leaflet Locate */
        #locate-btn {
            position: absolute; bottom: 30px; right: 10px; z-index: 1000;
            background: #2c3e50; color: white; border: none; border-radius: 50%;
            width: 44px; height: 44px; font-size: 20px; cursor: pointer;
            box-shadow: 0 3px 8px rgba(0,0,0,0.3);
        }
        #locate-btn:hover { background: #3d5166; }

        /* Tooltip */
        .stationinfo {
            position: fixed; background: rgba(44,62,80,0.93); color: white;
            padding: 6px 11px; border-radius: 5px; pointer-events: none;
            font-size: 13px; z-index: 9999; max-width: 240px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.25);
        }

        /* Leaflet Legende */
        #leaflet-legend {
            position: absolute; top: 10px; left: 10px; z-index: 1000;
            background: rgba(255,255,255,0.92); border-radius: 8px;
            padding: 8px 12px; font-size: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        #leaflet-legend h4 { margin: 0 0 5px; font-size: 13px; color: #2c3e50; }
        .legend-item { display: flex; align-items: center; gap: 6px; margin: 3px 0; }
        .legend-dot { width: 14px; height: 14px; border-radius: 50%; border: 2px solid white; flex-shrink: 0; }

        .U1{color:#7dad4c} .U2{color:#da421e} .U3{color:#16683d}
        .U4{color:#f0d722} .U5{color:#7e5330} .U6{color:#8c6dab}
        .U7{color:#009bd5} .U8{color:#224f86} .U9{color:#f3791d}
        .U12{color:#000768}
    </style>
</head>
<body>

<h1>BVG Berlin ‚Äì Live U-Bahn Tracker</h1>

<div class="controls">
    <button id="toggle-live" class="control-button active">Live-Daten deaktivieren</button>
    <button id="refresh-data" class="control-button">Aktualisieren</button>
    <button id="fullscreen-toggle" class="control-button">Vollbild</button>
    <div id="map-mode-toggle">
        <button id="mode-schematic" class="active">üó∫ Schematisch</button>
        <button id="mode-real">üõ∞ Echte Karte</button>
    </div>
</div>

<div class="refresh-info">
    Letzte Aktualisierung: <span id="last-update">‚Äì</span>
    | Aktive Fahrzeuge: <span id="train-count">0</span>
</div>

<div id="line-toggle-container">
    <label><input type="checkbox" class="line-toggle" value="U1" checked> U1</label>
    <label><input type="checkbox" class="line-toggle" value="U2" checked> U2</label>
    <label><input type="checkbox" class="line-toggle" value="U3" checked> U3</label>
    <label><input type="checkbox" class="line-toggle" value="U4" checked> U4</label>
    <label><input type="checkbox" class="line-toggle" value="U5" checked> U5</label>
    <label><input type="checkbox" class="line-toggle" value="U6" checked> U6</label>
    <label><input type="checkbox" class="line-toggle" value="U7" checked> U7</label>
    <label><input type="checkbox" class="line-toggle" value="U8" checked> U8</label>
    <label><input type="checkbox" class="line-toggle" value="U9" checked> U9</label>
</div>

<!-- Schematische Karte -->
<div id="svg-container" style="position: relative;">
    <div id="zoom-controls">
        <button class="zoom-btn" id="zoom-in" title="Hineinzoomen">+</button>
        <button class="zoom-btn" id="zoom-reset" title="Zur√ºcksetzen" style="font-size:13px;">‚åÇ</button>
        <button class="zoom-btn" id="zoom-out" title="Herauszoomen">‚àí</button>
    </div>
</div>

<!-- Echte Karte -->
<div id="leaflet-container">
    <div id="leaflet-map"></div>
    <div id="leaflet-legend">
        <h4>Fahrzeugtypen</h4>
        <div class="legend-item">
            <div class="legend-dot" style="background:#95a5a6;border:3px solid #115D91"></div> U-Bahn
        </div>
        <div class="legend-item">
            <div class="legend-dot" style="background:#95a5a6;border:3px solid #008D4F"></div> S-Bahn
        </div>
        <div class="legend-item">
            <div class="legend-dot" style="background:#95a5a6;border:3px solid #95276E"></div> Bus
        </div>
        <div class="legend-item">
            <div class="legend-dot" style="background:#95a5a6;border:3px solid #BE1414"></div> Tram
        </div>
        <div class="legend-item">
            <div class="legend-dot" style="background:#95a5a6;border:3px solid #528DBA"></div> F√§hre
        </div>
        <div class="legend-item">
            <div class="legend-dot" style="background:#95a5a6;border:3px solid #7f8c8d"></div> Sonstige
        </div>
        <hr style="margin:6px 0;border-color:#ddd">
        <div class="legend-item">
            <button id="toggle-stations-btn" style="
                width:100%;padding:4px 8px;font-size:12px;cursor:pointer;
                background:#2c3e50;color:white;border:none;border-radius:4px;">
                üöâ Stationen ausblenden
            </button>
        </div>
    </div>
    <button id="locate-btn" title="Mein Standort">üìç</button>
</div>

<div id="stationinfo" class="stationinfo" style="display:none;"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ZUSTAND
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let svg, zoomBehavior, fitToScreen;
let liveMode = true;
let liveInterval;
let liveTrains = {};
let existingTrainIds = new Set();
let currentMapMode = 'schematic';

let leafletMap = null;
let leafletMarkers = {}; // id -> { marker, line }
let stationLayers = {}; // line -> LayerGroup
let stationsVisible = true;
let userMarker = null;

const lineColors = {
    U1:'#7dad4c', U2:'#da421e', U3:'#16683d', U4:'#f0d722',
    U5:'#7e5330', U6:'#8c6dab', U7:'#009bd5', U8:'#224f86',
    U9:'#f3791d', U12:'#1e05ff'
};

// Fallback-Farben nach Produkttyp
function getFallbackColor(productName, lineName) {
    if (lineName && lineColors[lineName]) return lineColors[lineName];
    switch ((productName || '').toUpperCase()) {
        case 'U':     return '#224f86';
        case 'S':     return '#c0392b';
        case 'BUS':   return '#e67e22';
        case 'TRAM':  return '#27ae60';
        case 'FERRY': return '#8e44ad';
        default:      return '#7f8c8d';
    }
}

// Produkttyp-Farbe f√ºr den RING ‚Äì offizielle BVG Kennfarben
function getTypeColor(productName) {
    switch ((productName || '').toUpperCase()) {
        case 'U':           return '#115D91'; // Verkehrsblau  RAL 5017
        case 'S':           return '#008D4F'; // Verkehrsgr√ºn  RAL 6024
        case 'BUS':         return '#95276E'; // Verkehrspurpur RAL 4006
        case 'TRAM':        return '#BE1414'; // Verkehrsrot   RAL 3020
        case 'FERRY':       return '#528DBA'; // Lichtblau     RAL 5012
        case 'REGIONAL':
        case 'REGIONAL_EXP':
        case 'NATIONAL':
        case 'NATIONAL_EXP': return '#BE1414'; // Bahn-Rot     RAL 3020
        default:            return '#7f8c8d'; // Grau
    }
}

// Gibt { fillColor, borderColor } zur√ºck
// fillColor   = color.bg aus API (Linienfarbe, Kreisf√ºllung) ‚Üí Fallback lineColors oder Grau
// borderColor = fixer Produkttyp-Farbe (Ring um den Kreis)
function getMarkerColors(v) {
    const productName = v.line?.productName || '';
    const lineName    = v.line?.name || '';

    // Ring = immer die Produkttyp-Farbe
    const borderColor = getTypeColor(productName);

    // F√ºllung = color.bg aus API, dann lineColors-Tabelle, dann Grau
    const apiBg = v.line?.color?.bg;
    let fillColor = apiBg || lineColors[lineName] || '#95a5a6';

    return { fillColor, borderColor };
}

function getProductLabel(productName) {
    switch ((productName || '').toUpperCase()) {
        case 'U':     return 'üöá';
        case 'S':     return 'üöÜ';
        case 'BUS':   return 'üöå';
        case 'TRAM':  return 'üöä';
        case 'FERRY': return '‚õ¥';
        default:      return 'üöê';
    }
}

let visibleLines = {U1:true,U2:true,U3:true,U4:true,U5:true,U6:true,U7:true,U8:true,U9:true,U12:true};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MODUS UMSCHALTEN
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
document.getElementById('mode-schematic').addEventListener('click', () => switchMode('schematic'));
document.getElementById('mode-real').addEventListener('click', () => switchMode('real'));

function switchMode(mode) {
    currentMapMode = mode;
    document.getElementById('mode-schematic').classList.toggle('active', mode==='schematic');
    document.getElementById('mode-real').classList.toggle('active', mode==='real');
    document.getElementById('svg-container').style.display = mode==='schematic' ? 'block' : 'none';
    document.getElementById('zoom-controls').style.display = mode==='schematic' ? 'flex' : 'none';
    document.getElementById('leaflet-container').style.display = mode==='real' ? 'block' : 'none';
    document.getElementById('fullscreen-toggle').style.display = mode==='schematic' ? '' : 'none';

    if (mode === 'real') {
        initLeaflet();
        setTimeout(() => leafletMap && leafletMap.invalidateSize(), 120);
    }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// LEAFLET
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function initLeaflet() {
    if (leafletMap) return;
    leafletMap = L.map('leaflet-map').setView([52.520, 13.405], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap'
    }).addTo(leafletMap);

    // Stationsmarker (U-Bahn) ‚Äì pro Linie eine LayerGroup
    const linesData = {
        U1:typeof u1Points!=='undefined'?u1Points:[],
        U2:typeof u2Points!=='undefined'?u2Points:[],
        U3:typeof u3Points!=='undefined'?u3Points:[],
        U4:typeof u4Points!=='undefined'?u4Points:[],
        U5:typeof u5Points!=='undefined'?u5Points:[],
        U6:typeof u6Points!=='undefined'?u6Points:[],
        U7:typeof u7Points!=='undefined'?u7Points:[],
        U8:typeof u8Points!=='undefined'?u8Points:[],
        U9:typeof u9Points!=='undefined'?u9Points:[],
        U12:typeof u12Points!=='undefined'?u12Points:[]
    };
    stationLayers = {};
    Object.entries(linesData).forEach(([line, pts]) => {
        const group = L.layerGroup();
        pts.forEach(p => {
            if (p.station && p.xr && p.yr) {
                L.circleMarker([p.xr, p.yr], {
                    radius: 5,
                    color: lineColors[line] || '#333',
                    fillColor: 'white',
                    fillOpacity: 1,
                    weight: 2
                }).addTo(group).bindPopup(`<b>${p.station}</b><br>${line}`);
            }
        });
        stationLayers[line] = group;
        if (stationsVisible) group.addTo(leafletMap);
    });

    document.getElementById('locate-btn').addEventListener('click', () => {
        if (userMarker) leafletMap.setView(userMarker.getLatLng(), 15, {animate:true});
        else alert("Standort noch nicht verf√ºgbar");
    });

    startGeoWatch();

    // Stationen ein-/ausblenden
    document.getElementById('toggle-stations-btn').addEventListener('click', function() {
        stationsVisible = !stationsVisible;
        this.textContent = stationsVisible ? 'üöâ Stationen ausblenden' : 'üöâ Stationen anzeigen';
        Object.values(stationLayers).forEach(group => {
            if (stationsVisible) group.addTo(leafletMap);
            else leafletMap.removeLayer(group);
        });
    });
}

function startGeoWatch() {
    if (!navigator.geolocation) return;
    navigator.geolocation.watchPosition(pos => {
        const {latitude:lat, longitude:lng} = pos.coords;
        if (!userMarker) {
            userMarker = L.marker([lat,lng], {
                icon: L.icon({iconUrl:'https://upload.wikimedia.org/wikipedia/commons/e/ec/RedDot.svg', iconSize:[14,14]})
            }).addTo(leafletMap).bindPopup('Dein Standort');
        } else {
            userMarker.setLatLng([lat,lng]);
        }
    }, null, {enableHighAccuracy:true});
}

// ‚îÄ‚îÄ Alle Fahrzeuge auf der echten Karte anzeigen (keine Produktfilterung mehr)
function updateLeafletTrains(movements) {
    if (!leafletMap) return;
    const seen = new Set();

    movements.forEach(v => {
        // Nur √ºberspringen wenn keine Positionsdaten oder keine Linie
        if (!v.location || !v.line || !v.line.name) return;

        const line = v.line.name;
        const productName = v.line?.productName || '';
        const id = v.tripId;
        if (!id) return;

        // F√ºr U-Bahn-Linien: Sichtbarkeits-Filter anwenden
        if (productName === 'U' && !visibleLines[line]) return;

        seen.add(id);

        const lat = v.location.latitude;
        const lng = v.location.longitude;
        const dest = v.direction || '?';
        const { fillColor, borderColor } = getMarkerColors(v);
        const emoji = getProductLabel(productName);
        const delay = v.delay ? ` | +${Math.round(v.delay/60)} min` : '';

        const popupContent = `${emoji} <b>${line}</b><br>‚Üí ${dest}${delay}`;

        if (leafletMarkers[id]) {
            leafletMarkers[id].marker.setLatLng([lat, lng]);
            leafletMarkers[id].marker.setStyle({ fillColor, color: borderColor });
            leafletMarkers[id].marker.getPopup()?.setContent(popupContent);
        } else {
            // Unterschiedliche Gr√∂√üen nach Produkttyp
            const radius = productName === 'U' ? 10 : (productName === 'S' ? 9 : 7);
            const marker = L.circleMarker([lat, lng], {
                radius,
                color: borderColor,   // Rand = color.fg aus API oder Fallback
                fillColor: fillColor, // F√ºllung = color.bg aus API oder Fallback
                fillOpacity: 1,
                weight: 2.5
            }).addTo(leafletMap).bindPopup(popupContent);

            marker.on('click', () => marker.openPopup());
            leafletMarkers[id] = { marker, line, productName };
        }
    });

    // Veraltete Marker entfernen
    Object.keys(leafletMarkers).forEach(id => {
        if (!seen.has(id)) {
            leafletMap.removeLayer(leafletMarkers[id].marker);
            delete leafletMarkers[id];
        }
    });
}

// Linien-Checkboxen ‚Äì Leaflet-Marker zeigen/verstecken (nur U-Bahn betroffen)
document.querySelectorAll('.line-toggle').forEach(cb => {
    cb.addEventListener('change', function() {
        const line = this.value;
        visibleLines[line] = this.checked;
        // Schematisch
        d3.selectAll(`.live-train.${line}`).style('display', this.checked ? 'inline' : 'none');
        // Leaflet: nur U-Bahn-Marker filtern
        Object.entries(leafletMarkers).forEach(([id, {marker, line:ml, productName}]) => {
            if (productName === 'U' && ml === line) {
                if (this.checked) marker.addTo(leafletMap);
                else leafletMap?.removeLayer(marker);
            }
        });
    });
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SCHEMATISCHE KARTE (D3)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
document.getElementById('fullscreen-toggle').addEventListener('click', function() {
    const c = document.getElementById('svg-container');
    if (!document.fullscreenElement) c.requestFullscreen().catch(e=>alert(e.message));
    else document.exitFullscreen();
});

d3.xml("bvggrafik1a.svg").then(function(xml) {
    const container = document.getElementById("svg-container");
    const zoomControls = document.getElementById("zoom-controls");
    container.insertBefore(xml.documentElement, zoomControls);
    svg = d3.select("svg");

    const svgNode = svg.node();
    const vb = svgNode.viewBox.baseVal;
    const svgW = vb.width  || 1000;
    const svgH = vb.height || 800;

    const zoomGroup = document.createElementNS("http://www.w3.org/2000/svg","g");
    zoomGroup.setAttribute("class","zoom-layer");
    while (svgNode.firstChild) zoomGroup.appendChild(svgNode.firstChild);
    svgNode.appendChild(zoomGroup);
    const zoomSel = d3.select(zoomGroup);

    svg.style("width","100%").style("height","90vh").style("display","block");

    fitToScreen = function() {
        const cw = container.clientWidth  || window.innerWidth;
        const ch = container.clientHeight || window.innerHeight;
        const s = Math.min(cw/svgW, ch/svgH) * 0.97;
        svg.call(zoomBehavior.transform, d3.zoomIdentity.translate((cw-svgW*s)/2,(ch-svgH*s)/2).scale(s));
    };

    zoomBehavior = d3.zoom().scaleExtent([0.3,10])
        .on("zoom", e => zoomSel.attr("transform", e.transform));

    svg.call(zoomBehavior);
    container.addEventListener("wheel", e=>e.preventDefault(), {passive:false});
    setTimeout(fitToScreen, 50);

    document.getElementById("zoom-in").addEventListener("click", () =>
        svg.transition().duration(250).call(zoomBehavior.scaleBy, 1.5));
    document.getElementById("zoom-out").addEventListener("click", () =>
        svg.transition().duration(250).call(zoomBehavior.scaleBy, 1/1.5));
    document.getElementById("zoom-reset").addEventListener("click", fitToScreen);
    document.addEventListener("fullscreenchange", () => setTimeout(fitToScreen,150));
    window.addEventListener("resize", fitToScreen);

    const stationinfo = d3.select("#stationinfo");

    const allLines = {
        U1:typeof u1Points!=='undefined'?u1Points:[],
        U2:typeof u2Points!=='undefined'?u2Points:[],
        U3:typeof u3Points!=='undefined'?u3Points:[],
        U4:typeof u4Points!=='undefined'?u4Points:[],
        U5:typeof u5Points!=='undefined'?u5Points:[],
        U6:typeof u6Points!=='undefined'?u6Points:[],
        U7:typeof u7Points!=='undefined'?u7Points:[],
        U8:typeof u8Points!=='undefined'?u8Points:[],
        U9:typeof u9Points!=='undefined'?u9Points:[],
        U12:typeof u12Points!=='undefined'?u12Points:[]
    };

    function findNearestPoint(lat,lon,line) {
        const pts=allLines[line]; if(!pts?.length) return null;
        let best=null, minD=Infinity;
        pts.forEach(p=>{const d=Math.hypot(p.xr-lat,p.yr-lon);if(d<minD){minD=d;best=p;}});
        return best;
    }
    function findNextStation(cp,line,dir) {
        const pts=allLines[line]; if(!pts?.length) return "Unbekannt";
        let ci=-1;
        for(let i=0;i<pts.length;i++){if(Math.abs(pts[i].x-cp.x)<5&&Math.abs(pts[i].y-cp.y)<5){ci=i;break;}}
        if(ci===-1) return "Unbekannt";
        const arr=dir===1?pts.slice(ci+1):pts.slice(0,ci).reverse();
        for(const p of arr){if(p.station&&!p.station.toLowerCase().includes("zwischen"))return p.station;}
        return "ENDE";
    }
    function determineDirection(prev,cp,line) {
        const pts=allLines[line]; if(!pts||pts.length<2) return 1;
        let pi=-1,ci=-1;
        pts.forEach((p,i)=>{
            if(Math.abs(p.x-prev.x)<5&&Math.abs(p.y-prev.y)<5)pi=i;
            if(Math.abs(p.x-cp.x)<5&&Math.abs(p.y-cp.y)<5)ci=i;
        });
        return(pi===-1||ci===-1)?1:(ci>pi?1:-1);
    }
    function checkAndCleanDuplicates() {
        existingTrainIds.clear();
        const elems=document.querySelectorAll('[data-train-id]');
        const map=new Map();
        elems.forEach(el=>{
            const id=el.getAttribute('data-train-id');
            existingTrainIds.add(id);
            if(!map.has(id))map.set(id,[]);
            map.get(id).push(el);
        });
        map.forEach((els,id)=>{for(let i=1;i<els.length;i++)els[i].remove();});
        Object.keys(liveTrains).forEach(id=>{
            const els=document.querySelectorAll(`[data-train-id="${id}"]`);
            if(els.length===0)delete liveTrains[id];
            else if(els.length>1){liveTrains[id].element=d3.select(els[0]);for(let i=1;i<els.length;i++)els[i].remove();}
        });
    }

    // ‚îÄ‚îÄ Haupt-Fetch (f√ºr beide Modi)
    async function fetchLiveData() {
        try {
            checkAndCleanDuplicates();
            const res = await fetch('https://v6.vbb.transport.rest/radar?north=52.5994968&west=13.1926072&south=52.4122984&east=13.6351573&results=1000');
            const data = await res.json();
            if (!data?.movements) return;
            const now = new Date();

            // Leaflet updaten ‚Äì alle Fahrzeuge
            if (currentMapMode === 'real') updateLeafletTrains(data.movements);

            // Schematisch: nur U-Bahn
            const toRemove = new Set(Object.keys(liveTrains));

            data.movements.forEach(v => {
                if (!v.line||v.line.productName!=='U'||!v.location||!v.line.name) return;
                const line=v.line.name, tripId=v.tripId;
                if(!tripId) return;
                const uid=`${line}_${tripId}`;
                toRemove.delete(uid);
                const np=findNearestPoint(v.location.latitude,v.location.longitude,line);
                if(!np) return;

                if (existingTrainIds.has(uid) && liveTrains[uid]) {
                    const prev=liveTrains[uid];
                    const dir=determineDirection(prev,np,line);
                    if((prev.x!==np.x||prev.y!==np.y)&&prev.element)
                        prev.element.attr("x",np.x).attr("y",np.y);
                    liveTrains[uid]={...prev,x:np.x,y:np.y,lastUpdated:now,
                        nextStation:findNextStation(np,line,dir),direction:v.direction||"Unbekannt"};
                } else {
                    const path=line==="U12"?"u12punkt1.svg":`${line.toLowerCase()}punkt1.svg`;
                    d3.xml(path).then(tx=>{
                        const train=svg.node().appendChild(tx.documentElement);
                        const bb=train.getBBox(), sc=0.5;
                        train.setAttribute("width",  bb.width*sc);
                        train.setAttribute("height", bb.height*sc);
                        train.setAttribute("x", np.x);
                        train.setAttribute("y", np.y);
                        train.setAttribute("class",`live-train ${line}`);
                        train.setAttribute("data-train-id", uid);
                        if(!visibleLines[line]) train.style.display='none';

                        train.addEventListener("mouseenter",()=>{
                            const td=liveTrains[uid];
                            const ns=td?.nextStation||"Unbekannt";
                            stationinfo.style("display","block")
                                .html(`<strong>${line}</strong><br>‚Üí ${td?.direction||'?'}`+
                                      (ns==="ENDE"?"<br>Fahrt endet hier":`<br>N√§chste: ${ns}`));
                        });
                        train.addEventListener("mousemove",e=>{
                            stationinfo.style("left",(e.clientX+12)+"px").style("top",(e.clientY+12)+"px");
                        });
                        train.addEventListener("mouseleave",()=>stationinfo.style("display","none"));

                        liveTrains[uid]={
                            element:d3.select(train),line,lastUpdated:now,
                            x:np.x,y:np.y,nextStation:findNextStation(np,line,1),
                            direction:v.direction||"Unbekannt"
                        };
                        existingTrainIds.add(uid);
                        updateTrainCount();
                    }).catch(()=>{});
                }
            });

            toRemove.forEach(id=>{
                liveTrains[id]?.element?.remove();
                delete liveTrains[id]; existingTrainIds.delete(id);
            });
            Object.keys(liveTrains).forEach(id=>{
                if(now-liveTrains[id].lastUpdated>120000){
                    liveTrains[id]?.element?.remove();
                    delete liveTrains[id]; existingTrainIds.delete(id);
                }
            });

            document.getElementById('last-update').textContent=now.toLocaleTimeString('de-DE');
            updateTrainCount();
        } catch(e){console.error("Fehler:",e);}
    }

    function updateTrainCount() {
        // Z√§hlt U-Bahn (schematisch) + alle Leaflet-Fahrzeuge
        const leafletCount = currentMapMode === 'real' ? Object.keys(leafletMarkers).length : 0;
        const schematicCount = currentMapMode === 'schematic' ? existingTrainIds.size : 0;
        document.getElementById('train-count').textContent = leafletCount || schematicCount;
    }

    // Toggle-Button
    document.getElementById('toggle-live').addEventListener('click', function() {
        liveMode=!liveMode;
        this.textContent=liveMode?'Live-Daten deaktivieren':'Live-Daten aktivieren';
        this.classList.toggle('active',liveMode);
        if(liveMode){
            checkAndCleanDuplicates(); fetchLiveData();
            liveInterval=setInterval(fetchLiveData,3000);
        } else {
            clearInterval(liveInterval);
            Object.keys(liveTrains).forEach(id=>{liveTrains[id]?.element?.remove();});
            liveTrains={}; existingTrainIds.clear();
            Object.values(leafletMarkers).forEach(({marker})=>leafletMap?.removeLayer(marker));
            leafletMarkers={};
            updateTrainCount();
        }
    });

    document.getElementById('refresh-data').addEventListener('click',()=>{if(liveMode)fetchLiveData();});

    // ‚îÄ‚îÄ AUTOMATISCH STARTEN
    fetchLiveData();
    liveInterval=setInterval(fetchLiveData,3000);

}).catch(e=>console.error("SVG-Fehler:",e));
</script>
</body>
</html>