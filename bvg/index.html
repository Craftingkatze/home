<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BVG Berlin - Live</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="trainRoutes.js"></script> 
    <style>
        body { font-family: Arial, sans-serif; text-align: center; }
        #slider-container { 
            margin: 20px;
            display: flex;
            flex-direction: row;
        }
        svg { border: 1px solid #ccc; width: 100%; height: auto; }
        .slider-label { display: block; margin-bottom: 5px; }
        .slider-wrapper { display: flex; flex-direction: column; align-items: center; margin-right: 10px; }
        #spawn-controls { margin-top: 20px; }
        #auto-all { margin-top: 10px; }
        
        .stationinfo {
            position: absolute;
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            pointer-events: none;
            font-size: 14px;
            z-index: 1000;
            max-width: 250px;
        }
        
        .live-train {
            fill: currentColor;
            stroke: white;
            stroke-width: 2;
            r: 8;
            z-index: 10;
        }
        
        .controls {
            margin: 15px 0;
        }
        
        .control-button {
            padding: 8px 15px;
            background-color: #2c3e50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 0 5px;
        }
        
        .refresh-info {
            margin-top: 10px;
            font-size: 14px;
            color: #666;
        }
        
        /* Linienfarben */
        .U1 { color: #7dad4c; }
        .U2 { color: #da421e; }
        .U3 { color: #16683d; }
        .U4 { color: #f0d722; }
        .U5 { color: #7e5330; }
        .U6 { color: #8c6dab; }
        .U7 { color: #009bd5; }
        .U8 { color: #224f86; }
        .U9 { color: #f3791d; }
        .U12 { color: #000768; }
    </style>
</head>
<body>
    <h1>BVG Berlin - Live U-Bahn Tracker</h1>

    <div class="controls">
        <button id="toggle-live" class="control-button">Live-Daten aktivieren</button>
        <button id="refresh-data" class="control-button">Daten aktualisieren</button>
        <button id="fullscreen-toggle" class="control-button">Vollbild</button>
    </div>

    <div class="refresh-info">
        Letzte Aktualisierung: <span id="last-update">-</span>
        | Aktive Züge: <span id="train-count">0</span>
    </div>

    <div id="line-toggle-container" class="controls">
        <label><input type="checkbox" class="line-toggle" value="U1" checked> U1</label>
        <label><input type="checkbox" class="line-toggle" value="U2" checked> U2</label>
        <label><input type="checkbox" class="line-toggle" value="U3" checked> U3</label>
        <label><input type="checkbox" class="line-toggle" value="U4" checked> U4</label>
        <label><input type="checkbox" class="line-toggle" value="U5" checked> U5</label>
        <label><input type="checkbox" class="line-toggle" value="U6" checked> U6</label>
        <label><input type="checkbox" class="line-toggle" value="U7" checked> U7</label>
        <label><input type="checkbox" class="line-toggle" value="U8" checked> U8</label>
        <label><input type="checkbox" class="line-toggle" value="U9" checked> U9</label>
        <label><input type="checkbox" class="line-toggle" value="U12" checked> U12</label>
    </div>

    <div id="svg-container" style="position: relative;"></div>
    <div id="stationinfo" class="stationinfo" style="display: none;"></div>

    <script>
        // Karte laden
        let svg;
        let liveMode = false;
        let liveInterval;
        let liveTrains = {};
        
        // Set zur Überprüfung existierender IDs
        let existingTrainIds = new Set();
        
        // Vollbild-Funktion
        document.getElementById('fullscreen-toggle').addEventListener('click', function () {
            const container = document.getElementById('svg-container');
            if (!document.fullscreenElement) {
                container.requestFullscreen().catch(err => {
                    alert(`Fehler beim Aktivieren des Vollbildmodus: ${err.message}`);
                });
            } else {
                document.exitFullscreen();
            }
        });

        // Linien-Ein-/Ausblendung
        d3.selectAll(".line-toggle").on("change", function () {
            const line = this.value;
            const isVisible = this.checked;

            d3.selectAll(`.live-train.${line}`).style("display", isVisible ? "inline" : "none");
        });

        d3.xml("bvggrafik1.svg").then(function(xml) {
            document.getElementById("svg-container").appendChild(xml.documentElement);
            svg = d3.select("svg");
            
            // Tooltip für Stationen
            const stationinfo = d3.select("#stationinfo");
            
            // Alle Linien zusammenfassen
            const allLines = {
                'U1': typeof u1Points !== 'undefined' ? u1Points : [],
                'U2': typeof u2Points !== 'undefined' ? u2Points : [],
                'U3': typeof u3Points !== 'undefined' ? u3Points : [],
                'U4': typeof u4Points !== 'undefined' ? u4Points : [],
                'U5': typeof u5Points !== 'undefined' ? u5Points : [],
                'U6': typeof u6Points !== 'undefined' ? u6Points : [],
                'U7': typeof u7Points !== 'undefined' ? u7Points : [],
                'U8': typeof u8Points !== 'undefined' ? u8Points : [],
                'U9': typeof u9Points !== 'undefined' ? u9Points : [],
                'U12': typeof u12Points !== 'undefined' ? u12Points : []
            };
            
            // Funktion zum Finden des nächsten Punkts auf der Karte
            function findNearestPoint(lat, lon, line) {
                const linePoints = allLines[line];
                if (!linePoints || linePoints.length === 0) return null;
                
                let nearestPoint = null;
                let minDistance = Infinity;
                
                linePoints.forEach(point => {
                    const distance = Math.sqrt(
                        Math.pow(point.xr - lat, 2) + 
                        Math.pow(point.yr - lon, 2)
                    );
                    
                    if (distance < minDistance) {
                        minDistance = distance;
                        nearestPoint = point;
                    }
                });
                
                return nearestPoint;
            }
            
            // Funktion zum Finden der nächsten Station basierend auf der aktuellen Position
            function findNextStation(currentPoint, line, direction) {
                const linePoints = allLines[line];
                if (!linePoints || linePoints.length === 0) return "Unbekannt";
                
                let currentIndex = -1;
                
                // Finde den aktuellen Punkt in der Route
                for (let i = 0; i < linePoints.length; i++) {
                    if (Math.abs(linePoints[i].x - currentPoint.x) < 5 && 
                        Math.abs(linePoints[i].y - currentPoint.y) < 5) {
                        currentIndex = i;
                        break;
                    }
                }
                
                if (currentIndex === -1) return "Unbekannt";
                
                // Bestimme die nächste Station basierend auf der Fahrtrichtung
                if (direction === 1) {
                    // Vorwärtsrichtung - suche nächste Station mit Namen
                    for (let i = currentIndex + 1; i < linePoints.length; i++) {
                        if (linePoints[i].station && 
                            !linePoints[i].station.includes("Zwischen") && 
                            !linePoints[i].station.includes("zwischen")) {
                            return linePoints[i].station;
                        }
                    }
                    // Wenn keine nächste Station gefunden, ist es die Endstation
                    return "ENDE";
                } else {
                    // Rückwärtsrichtung - suche vorherige Station mit Namen
                    for (let i = currentIndex - 1; i >= 0; i--) {
                        if (linePoints[i].station && 
                            !linePoints[i].station.includes("Zwischen") && 
                            !linePoints[i].station.includes("zwischen")) {
                            return linePoints[i].station;
                        }
                    }
                    // Wenn keine vorherige Station gefunden, ist es die Endstation
                    return "ENDE";
                }
            }
            
            // Funktion zum Bestimmen der Fahrtrichtung
            function determineDirection(prevTrain, currentPoint, line) {
                if (!prevTrain) return 1; // Standard: vorwärts
                
                const linePoints = allLines[line];
                if (!linePoints || linePoints.length < 2) return 1;
                
                let prevIndex = -1;
                let currentIndex = -1;
                
                // Finde Indizes der vorherigen und aktuellen Position
                for (let i = 0; i < linePoints.length; i++) {
                    if (Math.abs(linePoints[i].x - prevTrain.x) < 5 && 
                        Math.abs(linePoints[i].y - prevTrain.y) < 5) {
                        prevIndex = i;
                    }
                    if (Math.abs(linePoints[i].x - currentPoint.x) < 5 && 
                        Math.abs(linePoints[i].y - currentPoint.y) < 5) {
                        currentIndex = i;
                    }
                }
                
                if (prevIndex === -1 || currentIndex === -1) return 1;
                
                return currentIndex > prevIndex ? 1 : -1;
            }
            
            // Funktion zur Überprüfung auf Duplikate und Bereinigung
            function checkAndCleanDuplicates() {
                // Setze existingTrainIds zurück
                existingTrainIds.clear();
                
                // Finde alle existierenden Zug-Elemente im DOM
                const existingTrainElements = document.querySelectorAll('[data-train-id]');
                
                // Map zur Verfolgung von Elementen pro ID
                const elementsPerId = new Map();
                
                // Sammle alle Elemente pro ID
                existingTrainElements.forEach(element => {
                    const trainId = element.getAttribute('data-train-id');
                    
                    if (!elementsPerId.has(trainId)) {
                        elementsPerId.set(trainId, []);
                    }
                    elementsPerId.get(trainId).push(element);
                    
                    // Füge ID zum Set hinzu
                    existingTrainIds.add(trainId);
                });
                
                // Entferne Duplikate (behalte nur das erste Element pro ID)
                elementsPerId.forEach((elements, trainId) => {
                    if (elements.length > 1) {
                        console.log(`Duplikat gefunden für ID ${trainId}: ${elements.length} Elemente`);
                        
                        // Behalte nur das erste Element, entferne die restlichen
                        for (let i = 1; i < elements.length; i++) {
                            console.log(`Entferne Duplikat ${i} für ID ${trainId}`);
                            elements[i].remove();
                        }
                    }
                });
                
                // Synchronisiere liveTrains-Objekt mit DOM
                Object.keys(liveTrains).forEach(trainId => {
                    const existingElements = document.querySelectorAll(`[data-train-id="${trainId}"]`);
                    
                    // Wenn kein Element existiert, entferne aus liveTrains
                    if (existingElements.length === 0) {
                        delete liveTrains[trainId];
                    }
                    // Wenn zu viele Elemente, bereinige
                    else if (existingElements.length > 1) {
                        // Aktualisiere liveTrains mit dem ersten Element
                        liveTrains[trainId].element = d3.select(existingElements[0]);
                        
                        // Entferne zusätzliche Elemente
                        for (let i = 1; i < existingElements.length; i++) {
                            existingElements[i].remove();
                        }
                    }
                });
            }
            
            // Live-Daten abrufen
            async function fetchLiveData() {
                try {
                    // Überprüfe zuerst auf Duplikate und bereinige
                    checkAndCleanDuplicates();
                    
                    const response = await fetch(`https://v6.vbb.transport.rest/radar?north=52.5994968&west=13.1926072&south=52.4122984&east=13.6351573&results=1000`);
                    const data = await response.json();

                    if (data && data.movements) {
                        const updatedTrainIds = new Set();
                        const trainIdsToRemove = new Set(Object.keys(liveTrains));
                        const currentTime = new Date();

                        data.movements.forEach(vehicle => {
                            if (vehicle.line && vehicle.line.productName === 'U' && 
                                vehicle.location && vehicle.line.name) {
                                
                                const line = vehicle.line.name;
                                const tripId = vehicle.tripId;
                                
                                // Wenn keine Trip-ID vorhanden, überspringen
                                if (!tripId) return;
                                
                                // Generiere eine eindeutige ID aus Trip-ID und Linie
                                const uniqueId = `${line}_${tripId}`;
                                
                                // Prüfe ob diese ID bereits existiert
                                if (existingTrainIds.has(uniqueId)) {
                                    // ID existiert bereits - aktualisiere nur
                                    updatedTrainIds.add(uniqueId);
                                    trainIdsToRemove.delete(uniqueId);
                                    
                                    const nearestPoint = findNearestPoint(
                                        vehicle.location.latitude, 
                                        vehicle.location.longitude, 
                                        line
                                    );

                                    if (nearestPoint && liveTrains[uniqueId]) {
                                        const prevTrain = liveTrains[uniqueId];
                                        
                                        // Bestimme Fahrtrichtung
                                        const direction = determineDirection(prevTrain, nearestPoint, line);
                                        
                                        // Finde nächste Station
                                        const nextStation = findNextStation(nearestPoint, line, direction);
                                        
                                        // Aktualisiere nur Position wenn sie sich geändert hat
                                        if (prevTrain.x !== nearestPoint.x || prevTrain.y !== nearestPoint.y) {
                                            if (prevTrain.element) {
                                                prevTrain.element
                                                    .attr("x", nearestPoint.x)
                                                    .attr("y", nearestPoint.y);
                                            }
                                        }
                                        
                                        // Aktualisiere Daten
                                        liveTrains[uniqueId] = {
                                            ...prevTrain,
                                            x: nearestPoint.x,
                                            y: nearestPoint.y,
                                            lastUpdated: currentTime,
                                            nextStation: nextStation,
                                            direction: vehicle.direction || "Unbekannt"
                                        };
                                    }
                                } else {
                                    // Neue ID - erstelle neuen Zug
                                    updatedTrainIds.add(uniqueId);
                                    trainIdsToRemove.delete(uniqueId);
                                    
                                    const nearestPoint = findNearestPoint(
                                        vehicle.location.latitude, 
                                        vehicle.location.longitude, 
                                        line
                                    );

                                    if (nearestPoint) {
                                        // Bestimme Fahrtrichtung
                                        const direction = 1; // Standard für neue Züge
                                        const nextStation = findNextStation(nearestPoint, line, direction);
                                        
                                        // Erstelle SVG-Element für neuen Zug
                                        const trainSvgPath = line === "U12" 
                                            ? "u12punkt1.svg" 
                                            : `${line.toLowerCase()}punkt1.svg`;

                                        d3.xml(trainSvgPath).then(function(trainXml) {
                                            const train = svg.node().appendChild(trainXml.documentElement);
                                            const trainElement = d3.select(train);

                                            const bbox = train.getBBox();
                                            const scale = 0.5;
                                            train.setAttribute("width", bbox.width * scale);
                                            train.setAttribute("height", bbox.height * scale);
                                            train.setAttribute("x", nearestPoint.x);
                                            train.setAttribute("y", nearestPoint.y);
                                            train.setAttribute("class", `live-train ${line}`);
                                            train.setAttribute("data-train-id", uniqueId);

                                            // Mouse Events für Tooltip
                                            train.addEventListener("mouseenter", function (event) {
                                                const trainData = liveTrains[uniqueId];
                                                const direction = trainData?.direction || "Unbekannt";
                                                const nextStation = trainData?.nextStation || "Unbekannt";
                                                
                                                let tooltipText = `<strong>${line}</strong><br>Nach: ${direction}`;
                                                
                                                if (nextStation === "ENDE") {
                                                    tooltipText += `<br>Fahrt endet hier`;
                                                } else {
                                                    tooltipText += `<br>Nächste Station: ${nextStation}`;
                                                }
                                                
                                                stationinfo
                                                    .style("display", "block")
                                                    .html(tooltipText);
                                            });
                                            
                                            train.addEventListener("mousemove", function (event) {
                                                stationinfo
                                                    .style("left", (event.pageX + 10) + "px")
                                                    .style("top", (event.pageY + 10) + "px");
                                            });
                                            
                                            train.addEventListener("mouseleave", function () {
                                                stationinfo.style("display", "none");
                                            });

                                            // Speichere Zug-Daten
                                            liveTrains[uniqueId] = {
                                                element: trainElement,
                                                line: line,
                                                lastUpdated: currentTime,
                                                x: nearestPoint.x,
                                                y: nearestPoint.y,
                                                nextStation: nextStation,
                                                direction: vehicle.direction || "Unbekannt"
                                            };
                                            
                                            // Füge zur ID-Liste hinzu
                                            existingTrainIds.add(uniqueId);
                                            
                                            updateTrainCount();
                                            
                                        }).catch(error => console.error(`Fehler beim Laden von ${trainSvgPath}:`, error));
                                    }
                                }
                            }
                        });

                        // Entferne veraltete Züge (die nicht mehr in der API Response sind)
                        trainIdsToRemove.forEach(trainId => {
                            const oldTrain = liveTrains[trainId];
                            if (oldTrain && oldTrain.element) {
                                oldTrain.element.remove();
                            }
                            delete liveTrains[trainId];
                            existingTrainIds.delete(trainId);
                        });
                        
                        // Entferne Züge die zu alt sind (mehr als 2 Minuten nicht aktualisiert)
                        Object.keys(liveTrains).forEach(trainId => {
                            const train = liveTrains[trainId];
                            if (currentTime - train.lastUpdated > 120000) { // 2 Minuten
                                if (train.element) {
                                    train.element.remove();
                                }
                                delete liveTrains[trainId];
                                existingTrainIds.delete(trainId);
                            }
                        });

                        // Zeit anzeigen
                        document.getElementById('last-update').textContent = 
                            currentTime.toLocaleTimeString('de-DE');
                            
                        updateTrainCount();
                    }
                } catch (error) {
                    console.error("Fehler beim Abrufen der Live-Daten:", error);
                }
            }
            
            // Funktion zum Aktualisieren der Zug-Anzahl
            function updateTrainCount() {
                // Zähle nur eindeutige IDs
                const uniqueCount = existingTrainIds.size;
                document.getElementById('train-count').textContent = uniqueCount;
            }

            // Live-Modus umschalten
            document.getElementById('toggle-live').addEventListener('click', function() {
                liveMode = !liveMode;
                this.textContent = liveMode ? 'Live-Daten deaktivieren' : 'Live-Daten aktivieren';
                
                if (liveMode) {
                    // Vor dem Start bereinigen
                    checkAndCleanDuplicates();
                    fetchLiveData();
                    liveInterval = setInterval(fetchLiveData, 3000);
                } else {
                    clearInterval(liveInterval);
                    // Entferne alle Live-Züge
                    Object.keys(liveTrains).forEach(trainId => {
                        const train = liveTrains[trainId];
                        if (train.element) {
                            train.element.remove();
                        }
                    });
                    liveTrains = {};
                    existingTrainIds.clear();
                    updateTrainCount();
                }
            });
            
            // Manuelle Aktualisierung
            document.getElementById('refresh-data').addEventListener('click', function() {
                if (liveMode) {
                    checkAndCleanDuplicates();
                    fetchLiveData();
                }
            });
            
            // Initialisiere Zug-Anzahl
            updateTrainCount();
            
        }).catch(error => console.error("Fehler beim Laden von bvggrafik.svg:", error));
    </script>
</body>
</html>